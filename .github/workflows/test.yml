name: 'build-test'

on: # rebuild any PRs and main branch changes
  pull_request:
  push:
    branches:
      - main
      - 'releases/*'

env:
  PNPM_VERSION: latest

jobs:
  build: # make sure build/ci work properly
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false
      - name: Get pnpm store directory
        id: pnpm-cache
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
      - uses: actions/cache@v3
        name: Setup pnpm cache
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      - name: Install Deps
        run: pnpm install
      - run: |
          pnpm run all

  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
          - os: macos-latest
          - os: windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./
      - run: cargo prebuilt just
      - run: just --version
  test-version: # make sure that the right version can be downloaded
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./
      - run: "[[ \"$(cargo prebuilt --version)\" != \"\" ]]"
      - uses: ./
        with:
          prebuilt-version: 0.6.0
      - run: "[[ \"$(cargo prebuilt --version)\" == \"Version: 0.6.0\" ]]"
  test-linux-tools: # make sure the action works on a clean machine without building
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./
        with:
          pkgs: just,rtx-cli@1.34.0,bacon@2.11.0
      - run: just --version
      - run: which just
      - run: rtx --version
      - run: "[[ \"$(bacon --version)\" == \"bacon 2.11.0\" ]]"
  test-macos-tools: # make sure the action works on a clean machine without building
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./
        with:
          pkgs: just,rtx-cli@1.34.0,bacon@2.11.0
      - run: just --version
      - run: which just
      - run: rtx --version
      - run: "[[ \"$(bacon --version)\" == \"bacon 2.11.0\" ]]"
  test-windows-tools: # make sure the action works on a clean machine without building
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./
        with:
          pkgs: just,bacon@2.11.0
      - shell: bash
        run: just --version
      - run: where.exe just
      - shell: bash
        run: "[[ \"$(bacon --version)\" == \"bacon 2.11.0\" ]]"
  test-dup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./
        with:
          pkgs: just@1.14.0
      - run: "[[ \"$(just --version)\" == \"just 1.14.0\" ]]"
      - uses: ./
        with:
          out: false
          pkgs: just@1.14.0
      - run: "[[ \"$(just --version)\" == \"just 1.14.0\" ]]"
      - run: which just
  test-minisign:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
          - os: macos-latest
          - os: windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./
        with:
          prebuilt-verify: minisign
          pkgs: just@1.14.0
